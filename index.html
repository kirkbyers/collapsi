<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collapsi Game</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/board.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/ui-components.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <header>
        <h1>Collapsi</h1>
    </header>
    
    <main>
        <!-- Game board will be dynamically generated by JavaScript -->
        <div id="game-board" class="game-board">
            <!-- Static cards will be replaced by JavaScript -->
        </div>
    </main>
    
    <footer>
        <p>&copy; 2025 Collapsi Game</p>
    </footer>
    
    <!-- JavaScript files must be loaded in dependency order -->
    <script src="js/utils.js"></script>
    
    <!-- Movement module - load in dependency order -->
    <script src="js/movement/core/card-movement.js"></script>
    <script src="js/movement/core/position-utils.js"></script>
    <script src="js/movement/core/path-validation.js"></script>
    <script src="js/movement/validation/ending-validator.js"></script>
    <script src="js/movement/validation/optimized-validator.js"></script>
    <script src="js/movement/validation/movement-validator.js"></script>
    <script src="js/movement/joker/joker-state.js"></script>
    <script src="js/movement/joker/joker-validator.js"></script>
    <script src="js/movement/joker/joker-completion.js"></script>
    <script src="js/movement/execution/index.js"></script>
    <script src="js/movement/execution/rendering-integration.js"></script>
    <script src="js/movement/execution/turn-manager.js"></script>
    <script src="js/movement/execution/board-state-manager.js"></script>
    <script src="js/movement/execution/move-executor.js"></script>
    <script src="js/movement/execution/card-collapse-manager.js"></script>
    <script src="js/movement/visualization/path-highlighter.js"></script>
    <script src="js/movement/index.js"></script>
    
    <script src="js/board.js"></script>
    <script src="js/player.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game.js"></script>
    
    <!-- Initialize the game when page loads -->
    <script type="module">
        // Import the new UI system
        import { UI } from './js/ui/index.js';
        
        // Global game instance for UI integration
        let gameInstance = null;
        let uiSystem = null;
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, initializing Collapsi game...');
            
            try {
                // Initialize the game
                const shuffledDeck = initializeNewGame();
                
                // Convert deck to board and set up game state
                gameState.board = convertDeckToBoard(shuffledDeck);
                
                // Create and assign players
                gameState.players = createPlayers();
                setupPlayerJokerAssignments();
                
                // Place players on their starting jokers
                placePlayersOnJokers();
                
                // Render the board to DOM
                renderBoardToDOM(gameState.board);
                
                // Render player pawns
                renderPlayerPawns();
                
                // Highlight current player
                highlightCurrentPlayerPawn();
                
                // Set game status to playing
                gameState.gameStatus = 'playing';
                
                // Create game instance object for UI integration
                gameInstance = {
                    board: gameState.board,
                    players: gameState.players,
                    currentPlayer: getCurrentPlayer(),
                    gameStatus: gameState.gameStatus,
                    resetGame: function() {
                        // Reset game state
                        const shuffledDeck = initializeNewGame();
                        gameState.board = convertDeckToBoard(shuffledDeck);
                        gameState.players = createPlayers();
                        setupPlayerJokerAssignments();
                        placePlayersOnJokers();
                        gameState.gameStatus = 'playing';
                        
                        // Re-render everything
                        renderBoardToDOM(gameState.board);
                        renderPlayerPawns();
                        highlightCurrentPlayerPawn();
                        
                        console.log('Game reset successfully');
                    },
                    renderBoard: function() {
                        renderBoardToDOM(gameState.board);
                        renderPlayerPawns();
                        highlightCurrentPlayerPawn();
                    }
                };
                
                // Initialize the new UI system
                uiSystem = new UI(gameInstance);
                await uiSystem.initialize();
                
                console.log('Game and UI system initialized successfully!');
                console.log('Game state:', gameState);
                console.log('UI state:', uiSystem.getState());
                
            } catch (error) {
                console.error('Error initializing game:', error);
            }
        });
        
        // Make UI system available globally for debugging
        window.uiSystem = uiSystem;
        window.gameInstance = gameInstance;
    </script>
</body>
</html>